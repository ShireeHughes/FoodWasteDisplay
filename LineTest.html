<!doctype html>

<html lang="en">
<head>
  <!-- ******************************************************************************************************* -->
  <!-- * created 2017 by Shiree Hughes                                                                       * -->
  <!-- * used https://code.tutsplus.com/tutorials/building-a-multi-line-chart-using-d3js--cms-22935 tutorial * -->
  <!-- * updates:                                                                                            * -->
  <!-- *   - fixed obsolete calls from d3 v3 (now compatible with v4)                                        * -->
  <!-- *   - accepts data from external source instead of static data                                        * -->
  <!-- *   - x-axis uses time series                                                                         * -->
  <!-- ******************************************************************************************************* -->
  <meta charset="utf-8">

  <title>Food Waste at Atlantic Dining Hall</title>
  <meta name="description" content="food waste, FAU, Florida Atlantic University, I-SENSE, Institute of Sensing and Embedded Systems Engineering, IoT, Internet of Things, sustainability">
  <meta name="author" content="Shiree Hughes">

  <!-- ************************************** -->
  <!-- * Links for fonts and CSS Stylesheet * -->
  <!-- ************************************** -->
<!--  <link rel="stylesheet" type="text/css" href="https://rawgit.com/ShireeHughes/FoodWasteDisplay/master/stylesheet.css" /> -->
  <link href="https://fonts.googleapis.com/css?family=Pontano+Sans" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Anton" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Athiti" rel="stylesheet" />

  <!-- ************************************** -->
  <!-- *  Links for D3 and JQuery scripts   * -->
  <!-- ************************************** -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://cdn.rawgit.com/ShireeHughes/FoodWasteDisplay/67775e63ceda3f7aad22aff086962bd76303b5cc/retreiveData.js"></script>
  <script src="https://cdn.rawgit.com/ShireeHughes/FoodWasteDisplay/00a2c0711ee0bf74b8ca8f0825cb69f208ca4259/graphData.js"></script
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
<script>

</script>
</head>
<body>
 <div class="container">
 
        <div class="jumbotron">
<svg id="visualisation" width="1000" height="500"></svg>
 
        </div>
 
    </div>

<script>
//create data sets
var data = [],
    data2 = [],
    data3 = [],
    data4 = [];

//function for creating a timestamp in D3
var parseTime = d3.timeParse("%Y-%m-%dT%H:%M:%S.%LZ");

//call to retrieve data from MongoDB
retreiveData();

/*
 * Function to return max value
 * between value a and value b
 */
function findMax(a,b) {
   if(a < b) { return b; }
   else {
      return a;
   }
}

/* 
 * Function called in jsonp callback
 * this function parses the incoming JSON 
 * and creates two datasets: one for cafe1 
 * and one for cafe2
 * samples for each trash can are used to
 * create cumulative data points
 * 
 */
function getData(result) {
    var ndx;
    var cafe1Total = 0;
    var cafe2Total = 0;
    var max = 0;

    //place samples in the correct dataset
    for(ndx = 0; ndx < result.length; ndx++) {
        var current = result[ndx];
        var testWeight = Math.random() * 20 + 1;

        //add to cafe 1 dataset
        if(current.trash_can_id == "cafe_1") {
//           if(current.weight != 0) {
           if(testWeight != 0) {
              if(ndx > 0) {
                 cafe1Total -= result[ndx-1].weight;
              }
              cafe1Total += testWeight; //current.weight
           }           
           data.push({
               "x":parseTime(current.timestamp.$date),
               "y":cafe1Total
             });
                          
       //dummy datasets
        data4.push({
           "x":parseTime(current.timestamp.$date),
           "y":cafe1Total + 115
        });

        }

    
        //add to cafe 2 dataset
        if(current.trash_can_id == "cafe_2") {
//           if(current.weight != 0) {
           if(testWeight != 0) {
              if(ndx > 0) {
                 cafe2Total -= result[ndx-1].weight;
              }
              cafe2Total += testWeight//current[ndx].weight;
           }

           data2.push({
              "x":parseTime(current.timestamp.$date),
              "y":cafe2Total
           });
           //dummy datasets
           data3.push({
             "x":parseTime(current.timestamp.$date),
             "y":cafe2Total - 120
           });
        }
       
        //save max
        if( max < cafe1Total || max < cafe2Total ) {
           max = findMax(cafe1Total, cafe2Total);
        }
     }
     graphDataMultiLine(max,[data, data2, data3, data4]);
 }

  </script>
<style>
.axis path {
    fill: none;
    stroke: #777;
    shape-rendering: crispEdges;
}
.axis text {
    font-family: Pontano Sans;
    font-size: 13px;
}
</style>
</body>