<!doctype html>

<html lang="en">
<head>
  <!-- ******************************************************************************************************* -->
  <!-- * created 2017 by Shiree Hughes                                                                       * -->
  <!-- * used https://code.tutsplus.com/tutorials/building-a-multi-line-chart-using-d3js--cms-22935 tutorial * -->
  <!-- * updates:                                                                                            * -->
  <!-- *   - fixed obsolete calls from d3 v3 (now compatible with v4)                                        * -->
  <!-- *   - accepts data from external source instead of static data                                        * -->
  <!-- *   - x-axis uses time series                                                                         * -->
  <!-- ******************************************************************************************************* -->
  <meta charset="utf-8">

  <title>Food Waste at Atlantic Dining Hall</title>
  <meta name="description" content="food waste, FAU, Florida Atlantic University, I-SENSE, Institute of Sensing and Embedded Systems Engineering, IoT, Internet of Things, sustainability">
  <meta name="author" content="Shiree Hughes">

  <!-- ************************************** -->
  <!-- * Links for fonts and CSS Stylesheet * -->
  <!-- ************************************** -->
<!--  <link rel="stylesheet" type="text/css" href="https://rawgit.com/ShireeHughes/FoodWasteDisplay/master/stylesheet.css" /> -->
  <link href="https://fonts.googleapis.com/css?family=Pontano+Sans" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Anton" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Athiti" rel="stylesheet" />

  <!-- ************************************** -->
  <!-- *  Links for D3 and JQuery scripts   * -->
  <!-- ************************************** -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://cdn.rawgit.com/ShireeHughes/FoodWasteDisplay/dd9fb85d815e1cbd3bbed698d3b6cc7511d525c2/retreiveData.js"></script>

    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
<script>

</script>
</head>
<body>
 <div class="container">
 
        <div class="jumbotron">
<svg id="visualisation" width="1000" height="500"></svg>
 
        </div>
 
    </div>

<script>
//create data sets
var data = [],
    data2 = [];

//function for creating a timestamp in D3
var parseTime = d3.timeParse("%Y-%m-%dT%H:%M:%S.%LZ");

//call to retrieve data from MongoDB
retreiveData();

/*
 * Function to return max value
 * between value a and value b
 */
function findMax(a,b) {
   if(a < b) { return b; }
   else {
      return a;
   }
}

/* 
 * Function called in jsonp callback
 * this function parses the incoming JSON 
 * and creates two datasets: one for cafe1 
 * and one for cafe2
 * samples for each trash can are used to
 * create cumulative data points
 * 
 */
function getData(result) {
    var ndx;
    var cafe1Total = 0;
    var cafe2Total = 0;
    var max = 0;

    //place samples in the correct dataset
    for(ndx = 0; ndx < result.length; ndx++) {
        var current = result[ndx];
        var testWeight = Math.random() * 20 + 1;

        //add to cafe 1 dataset
        if(current.trash_can_id == "cafe_1") {
//           if(current.weight != 0) {
           if(testWeight != 0) {
              if(ndx > 0) {
                 cafe1Total -= result[ndx-1].weight;
              }
              cafe1Total += testWeight; //current.weight
           }           
           data.push({
               "x":parseTime(current.timestamp.$date),
               "y":cafe1Total
             });
        }

    
        //add to cafe 1 dataset
        if(current.trash_can_id == "cafe_2") {
//           if(current.weight != 0) {
           if(testWeight != 0) {
              if(ndx > 0) {
                 cafe2Total -= result[ndx-1].weight;
              }
              cafe2Total += testWeight//current[ndx].weight;
           }

           data2.push({
              "x":parseTime(current.timestamp.$date),
              "y":cafe2Total
           });
        }
       
        //save max
        if( max < cafe1Total || max < cafe2Total ) {
           max = findMax(cafe1Total, cafe2Total);
        }
     }
     graphData(max);
 }

function graphData(max) {

   // define scales, area, and axis information
   var vis = d3.select("#visualisation"),
       WIDTH = 1000,
       HEIGHT = 500,
       MARGINS = {
          top: 20,
          right: 20,
          bottom: 20,
          left: 50
       },
      xScale = d3.scaleTime().range([MARGINS.left, WIDTH - MARGINS.right]).domain([new Date('2016-12-17T00:00:00.000Z'), new Date('2016-12-18T00:00:00.000Z')]),
      yScale = d3.scaleLinear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([0,max]),
      xAxis = d3.axisBottom(xScale),  
      yAxis = d3.axisLeft(yScale);

   //Append x-axis to the graph
   vis.append("svg:g")
      .attr("class","axis") //allows us to manipulate the CSS
      .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")  //positions axis
      .call(xAxis);

   //Append y-axis to the graph
   vis.append("svg:g")
      .attr("class","axis") //allows us to manipulate the CSS
      .attr("transform", "translate(" + (MARGINS.left) + ",0)")
      .call(yAxis);

   //create line
   var lineGen = d3.line()
      .x(function(d) {
          return xScale(d.x);
       })
      .y(function(d) {
          return yScale(d.y);
      })
      .curve(d3.curveBasis);    //interpolation to smooth the line

    //add first data set
    vis.append('svg:path')
     .attr('d', lineGen(data))
     .attr('stroke', 'green')
     .attr('stroke-width', 2)
     .attr('fill', 'none');

    //add second data set
    vis.append('svg:path')
     .attr('d', lineGen(data2))
     .attr('stroke', 'blue')
     .attr('stroke-width', 2)
     .attr('fill', 'none');
  }
  console.log(data2);
  </script>
<style>
.axis path {
    fill: none;
    stroke: #777;
    shape-rendering: crispEdges;
}
.axis text {
    font-family: Pontano Sans;
    font-size: 13px;
}
</style>
</body>