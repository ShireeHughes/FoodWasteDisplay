<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Food Waste at Atlantic Dining Hall</title>
  <meta name="description" content="food waste, FAU, Florida Atlantic University, I-SENSE, Institute of Sensing and Embedded Systems Engineering, IoT, Internet of Things, sustainability">
  <meta name="author" content="Shiree Hughes">

  <!-- ************************************** -->
  <!-- * Links for fonts and CSS Stylesheet * -->
  <!-- ************************************** -->
  <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/ShireeHughes/FoodWasteDisplay/256c41539d1b6b09036bb0ea47831783e8c1a221/stylesheet.css" />
  <link href="https://fonts.googleapis.com/css?family=Pontano+Sans" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Anton" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Athiti" rel="stylesheet" />

  <!-- ************************************** -->
  <!-- *  Links for D3 and JQuery scripts   * -->
  <!-- ************************************** -->
<!--  <script src="https://d3js.org/d3.v3.min.js"></script>-->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://cdn.rawgit.com/ShireeHughes/FoodWasteDisplay/6592ba070277840936d1f394cfb72deeb374814a/JavaScript/liquidFillGauge.js"></script>
  <script src="https://cdn.rawgit.com/ShireeHughes/FoodWasteDisplay/dd9fb85d815e1cbd3bbed698d3b6cc7511d525c2/retreiveData.js"></script>
<!--  <script src="https://cdn.rawgit.com/ShireeHughes/FoodWasteDisplay/2bf67898dfdd7fa2112943a56abb6f64c9066f4b/graphData.js"></script>-->
<script>
/*
 * created 2017 by Shiree Hughes
 * adapted from envato tuts+ tutorial -- Building a Multi Line Chart Using D3
 *   ---> https://code.tutsplus.com/tutorials/building-a-multi-line-chart-using-d3js--cms-22935 tutorial
 *
 * updates to the original tutorial:
 *   - fixed obsolete calls from d3 v3 (code is now compatible with v4)
 *   - reconfigure to accept data from external source instead of static data
 *   - reconfigured x-axis to use time series
 */


/*
 * function to return color name for values
 * allows mapping of legends to charts
 */
function getColor(value) {
  switch(value) {
     case 0:
        return 'deepskyblue';
        break;
     case 1:
        return 'blue';
        break;
     case 2:
        return 'forestgreen';
        break;
     case 3:
        return 'darkseagreen';
        break;
     case 4:
        return 'goldenrod';
        break;
     case 5:
        return 'darkorange';
        break;
     case 6:
        return 'crimson';
        break;
     case 7:
        return 'darkmagenta';
        break;
     case 8:
        return 'indigo';
        break;
     case 9:
        return 'lightcoral';
        break;
     case 10:
        return 'black';
        break;
     case 11:
        return 'darkgray';
        break;
  } 
}


/* 
 * function to create a multiline graph 
 * supports up to 12 lines (colorless)
 */
function graphDataMultiLine(max, yesterday, datasets) {
   var today = new Date();
//   var yesterday = new Date(new Date().setHours(today.getHours() - 24));

   var height = $('#visualisation').height();
   var width = $('#visualisation').width();

   // define scales, area, and axis information
   var vis = d3.select("#visualisation"),
       WIDTH = width,
       HEIGHT = height,
       MARGINS = {
          top: 20,
          right: 20,
          bottom: 20,
          left: 50
       },
      xScale = d3.scaleTime().range([MARGINS.left, WIDTH - MARGINS.right]).domain([yesterday, today]),
      yScale = d3.scaleLinear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([0,max]),
      xAxis = d3.axisBottom(xScale),  
      yAxis = d3.axisLeft(yScale);

   //Append x-axis to the graph
   vis.append("svg:g")
      .attr("class","axis") //allows us to manipulate the CSS
      .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")  //positions axis
      .call(xAxis);

   //Append y-axis to the graph
   vis.append("svg:g")
      .attr("class","axis") //allows us to manipulate the CSS
      .attr("transform", "translate(" + (MARGINS.left) + ",0)")
      .call(yAxis)
      .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")
      .attr("fill", "#000")
      .text("Waste, lbs");

   //create line
   var lineGen = d3.line()
      .x(function(d) {
          return xScale(d.x);
       })
      .y(function(d) {
          return yScale(d.y);
      })
      .curve(d3.curveBasis);    //interpolation to smooth the line

    //add datasets
    var ndx;
    for(ndx = 0; ndx < datasets.length; ndx++) {
        vis.append('svg:path')
           .attr('d', lineGen(datasets[ndx]))
           .attr('stroke', getColor(ndx))
           .attr('stroke-width', 2)
           .attr('fill', 'none');
    }
  }
</script>

    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->

<style>
.axis path {
    fill: none;
    stroke: #fff!important;
    shape-rendering: crispEdges;
}
.axis text {
    font-family: Pontano Sans;
    font-size: 15px!important;
    color:#fff!important;
}</style>
</head>

<body>
<!--  <script src="js/scripts.js"></script> -->
  <div class="outer">
    <header>
    <div class="title-header">
      <h1>Overview <span class="adh">Atlantic Dining Hall</span> <span id="date"></span><h1>
    </div>
    </header>

    <article>
    <div class="main-display">
       <div>
          <div class="comic" style="text-align:center;">
              <h2>Reach For Your Goals</h2>
              <img src="https://github.com/ShireeHughes/FoodWasteDisplay/blob/master/Images/1.png?raw=true" /> 
<!--		   <img src="file:///Users/shughes/Documents/FoodWasteDisplay/Images/1.png" alt="hi" class="inline"/>-->
          </div>
       </div>
    </div>
   </article>

    <aside>
    <div class="charts-tips-more">
       <div>

          <div class="double-graph">
             <div class="graph">
                <h2>Total Food Wasted in 24hours</h2>
        	<svg id="fillgauge1" width="97%" height="250" onclick="gauge1.update(NewValue());"></svg>
             </div>
             <div class="graph">
                  <div class="container"> 
                      <h2>Food Waste</h2>
        	      <svg id="visualisation" width="500" height="250"></svg>
		    </div>

		    <div class="legend">
		        <span class="key"><i class="fa fa-square"></i> Trash Can #1</span>
		  	<span class="key"><i class="fa fa-square"></i> Trash Can #2</span>
		  	<span class="key"><i class="fa fa-square"></i> Total Waste in Trash Can #1</span>
		  	<span class="key"><i class="fa fa-square"></i> Total Waste in Trash Can #2</span>
		    </div>

             </div>
	  </div>

          <div class="us-map">
             <h2>Children Living in Food-Insecure Households (2014)*</h2>
             <div id="tooltip"></div><!-- div to hold tooltip. -->
             <svg width="960" height="600" id="statesvg"></svg> <!-- svg to hold the map. -->
             <script src="http://bl.ocks.org/NPashaP/raw/a74faf20b492ad377312/3513ad985b2fa93ea35f2fc864cb30540c298171/uStates.js"></script> <!-- creates uStates. -->
             <div class="map-legend">
                 <li>0%</li><li>25%</li><li>50%</li>
              </div> 
               <p class="citation">*Craig Gundersen et al. "<a href="http://www.feedingamerica.org/hunger-in-america/our-research/map-the-meal-gap/2014/map-the-meal-gap-2014-exec-summ.pdf" target="_blank">Map the Meal Gap</a>". <i>Feeding America</i>, pg. 30-31. 2015</p>
          </div>
          <svg id="visualisation" width="900" height="500"></svg>
          <svg id="fillgauge1" width="97%" height="250" onclick="gauge1.update(NewValue());"></svg>
<!--<svg id="fillgauge2" width="97%" height="250" onclick="gauge2.update(NewValue());"></svg>
<svg id="fillgauge3" width="19%" height="200" onclick="gauge3.update(NewValue());"></svg>
<svg id="fillgauge4" width="19%" height="200" onclick="gauge4.update(NewValue());"></svg>
<svg id="fillgauge5" width="19%" height="200" onclick="gauge5.update(NewValue());"></svg>
<svg id="fillgauge6" width="19%" height="200" onclick="gauge6.update(NewValue());"></svg>-->
<script language="JavaScript">
    var config1 = liquidFillGaugeDefaultSettings();
    config1.waveAnimateTime = 1000;
    var gauge1 = loadLiquidFillGauge("fillgauge1", 40, config1);

    function NewValue(){
        if(Math.random() > .5){
            return Math.round(Math.random()*100);
        } else {
            return (Math.random()*100).toFixed(1);
        }
    }
</script>

       </div>
       <div>
          <h2>Tips</h2>
          <ol>
             <li>Tip 1</li>
             <li>Tip 2</li>
             <li>Tip 3</li>
             <li>Tip 4</li>
             <li>Tip 5</li>
          </ol>
       </div>
    </div>
    </aside>

    <footer>
       Copyright &copy; I-SENSE
    </footer>
  </div>


  <!-- *************** SCRIPTS *************** -->
  <script src="https://cdn.rawgit.com/ShireeHughes/FoodWasteDisplay/004c0a8a8b1379bdc787be7d97b564597d160ad8/Map.js"></script>  

  <script>
    function writeDate() {
      var today = new Date();
      var dd = today.getDate();
      var mm = today.getMonth()+1; //January is 0!
      var yyyy = today.getFullYear();

      if(dd<10) {
          dd='0'+dd
      } 

      if(mm<10) {
          mm='0'+mm
      } 

      today = mm+'/'+dd+'/'+yyyy;
      //$('#date').html(today);
      document.getElementById('date').innerHTML = today;
      console.log(today);
      //document.write(today);
    }
  </script>
  <script>writeDate();</script>

<script>        
//<![CDATA[
//create data sets
var data = [],
    data2 = [],
    data3 = [],
    data4 = [];

//function for creating a timestamp in D3
//var parseTime = d3.timeParse("%Y-%m-%dT%H:%M:%S.%LZ");
var parseTime = d3.utcParse("%Y-%m-%dT%H:%M:%S.%LZ");

//call to retrieve data from MongoDB
retreiveData();

/*
 * Function to return max value
 * between value a and value b
 */
function findMax(a,b) {
   if(a < b) { return b; }
   else {
      return a;
   }
}

/* 
 * Function called in jsonp callback
 * this function parses the incoming JSON 
 * and creates two datasets: one for cafe1 
 * and one for cafe2
 * samples for each trash can are used to
 * create cumulative data points
 * 
 */
function getData(result) {
    var ndx;
    var cafe1Total = 0;
    var cafe2Total = 0;
    var max = 0;

    //place samples in the correct dataset
    for(ndx = 0; ndx < result.length; ndx++) {
        var current = result[ndx];
        //add to cafe 1 dataset
        if(current.trash_can_id == "cafe_1") {
           if(current.weight != 0) {
              if(ndx > 0) {
                 cafe1Total -= result[ndx-1].weight;
              }
              cafe1Total += current.weight;
           }           
           data.push({
               "x":parseTime(current.timestamp.$date),
               "y":current.weight
             });
           data3.push({
               "x":parseTime(current.timestamp.$date),
               "y":cafe1Total
             });
                          
        }

    
        //add to cafe 2 dataset
        if(current.trash_can_id == "cafe_2") {
           if(current.weight != 0) {
              if(ndx > 0) {
                 cafe2Total -= result[ndx-1].weight;
              }
              cafe2Total += current.weight;
           }
           data2.push({
              "x":parseTime(current.timestamp.$date),
              "y":current.weight
           });
	   data4.push({
               "x":parseTime(current.timestamp.$date),
               "y":cafe2Total
             });
        }

        //save max
        if( max < cafe1Total || max < cafe2Total ) {
           max = findMax(cafe1Total, cafe2Total);
        }
/*         if(max < current.weight) {
            max = current.weight;
          }*/
     }
     if(max == 0) {max = 5;}
console.log(cafe2Total+cafe1Total);
     var start;
     if(data[0].x < data2[0].x) { start = data[0].x; }
     else { start = data2[0].x; }

//     d3.selectAll("svg > *").remove();

     graphDataMultiLine(max, start, [data, data2,data3,data4]);
  //     graphDataMultiLine(max, start, [data, data2]);
//       graphDataMultiLine(max,[data3, data4]);
console.log(start);
     setTimeout(retreiveData, 60000);
      data = []
      data2 = [];
      data3 = [];
      data4 = [];
 }

function tooltipHtml(n, d){	/* function to create html content string in tooltip div. */
		return "<h4>"+n+"</h4><table>"+
			"<tr><td>Low</td><td>"+(d.low)+"</td></tr>"+
			"<tr><td>Average</td><td>"+(d.avg)+"</td></tr>"+
			"<tr><td>High</td><td>"+(d.high)+"</td></tr>"+
			"</table>";
	}
	
	var sampleData ={};	/* Sample random data. */	
	["HI", "AK", "FL", "SC", "GA", "AL", "NC", "TN", "RI", "CT", "MA",
	"ME", "NH", "VT", "NY", "NJ", "PA", "DE", "MD", "WV", "KY", "OH", 
	"MI", "WY", "MT", "ID", "WA", "DC", "TX", "CA", "AZ", "NV", "UT", 
	"CO", "NM", "OR", "ND", "SD", "NE", "IA", "MS", "IN", "IL", "MN", 
	"WI", "MO", "AR", "OK", "KS", "LS", "VA"]
		.forEach(function(d){ 
			var low=Math.round(100*Math.random()), 
				mid=Math.round(100*Math.random()), 
				high=Math.round(100*Math.random());
			sampleData[d]={low:d3.min([low,mid,high]), high:d3.max([low,mid,high]), 
					avg:Math.round((low+mid+high)/3), color:d3.interpolate("#ffffcc", "#800026")(low/100)}; 
		});
	
	/* draw states on id #statesvg */	
	uStates.draw("#statesvg", sampleData, tooltipHtml);
	
	d3.select(self.frameElement).style("height", "600px");
//]]>
</script>
<style>




</style>
  </body>
</html>
